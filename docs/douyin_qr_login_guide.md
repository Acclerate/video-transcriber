# æŠ–éŸ³æ‰«ç ç™»å½•ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

æŠ–éŸ³æ‰«ç ç™»å½•åŠŸèƒ½å…è®¸ç”¨æˆ·é€šè¿‡æ‰«æäºŒç»´ç è‡ªåŠ¨è·å–æŠ–éŸ³cookiesï¼Œè§£å†³è§†é¢‘è§£æè¿‡ç¨‹ä¸­çš„åçˆ¬è™«é™åˆ¶é—®é¢˜ã€‚è¿™ä¸ªåŠŸèƒ½é€šè¿‡æµè§ˆå™¨è‡ªåŠ¨åŒ–æŠ€æœ¯ï¼Œæä¾›ä¾¿æ·çš„ä¸€é”®ç™»å½•ä½“éªŒã€‚

## åŠŸèƒ½ç‰¹ç‚¹

- ğŸ”’ **å®‰å…¨å¯é **: ä½¿ç”¨å®˜æ–¹ç™»å½•æµç¨‹ï¼Œä¿æŠ¤ç”¨æˆ·éšç§
- âš¡ **å¿«é€Ÿä¾¿æ·**: ä¸€é”®å¯åŠ¨ï¼Œæ‰«ç å³å¯å®Œæˆç™»å½•
- ğŸ”„ **è‡ªåŠ¨æ›´æ–°**: è‡ªåŠ¨ä¿å­˜æœ€æ–°cookiesåˆ°æœ¬åœ°æ–‡ä»¶
- ğŸ“± **å®æ—¶çŠ¶æ€**: WebSocketå®æ—¶æ˜¾ç¤ºç™»å½•è¿›åº¦
- ğŸ›¡ï¸ **é”™è¯¯æ¢å¤**: æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼Œæé«˜æˆåŠŸç‡

## ä½¿ç”¨æ­¥éª¤

### 1. å¯åŠ¨æ‰«ç ç™»å½•

åœ¨Webç•Œé¢çš„"å•ä¸ªè½¬å½•"é¡µé¢é¡¶éƒ¨ï¼Œæ‰¾åˆ°"æŠ–éŸ³æ‰«ç ç™»å½•"å¡ç‰‡ï¼š

![æ‰«ç ç™»å½•ç•Œé¢](images/qr_login_interface.png)

ç‚¹å‡»"**å¼€å§‹æ‰«ç ç™»å½•**"æŒ‰é’®å¯åŠ¨ç™»å½•æµç¨‹ã€‚

### 2. æ‰«æäºŒç»´ç 

ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
- å¯åŠ¨æµè§ˆå™¨å¹¶è®¿é—®æŠ–éŸ³ç™»å½•é¡µé¢
- ç”Ÿæˆå¹¶æ˜¾ç¤ºäºŒç»´ç 
- æ˜¾ç¤ºå®æ—¶çŠ¶æ€æ›´æ–°

![äºŒç»´ç æ˜¾ç¤º](images/qr_code_display.png)

ä½¿ç”¨æ‰‹æœºä¸Šçš„**æŠ–éŸ³APP**æ‰«ææ˜¾ç¤ºçš„äºŒç»´ç ã€‚

### 3. ç¡®è®¤ç™»å½•

åœ¨æ‰‹æœºä¸Šï¼š
- æ‰“å¼€æŠ–éŸ³APP
- æ‰«æäºŒç»´ç 
- åœ¨APPä¸­ç¡®è®¤ç™»å½•æˆæƒ

é¡µé¢ä¼šå®æ—¶æ˜¾ç¤ºç™»å½•çŠ¶æ€ï¼š
- "ç­‰å¾…æ‰«ç ..." â†’ "æ‰«ææˆåŠŸï¼Œè¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤ç™»å½•" â†’ "ç™»å½•æˆåŠŸï¼"

### 4. å®Œæˆç™»å½•

ç™»å½•æˆåŠŸåï¼š
- ç³»ç»Ÿè‡ªåŠ¨ä¿å­˜cookiesåˆ° `cookies.txt` æ–‡ä»¶
- çŠ¶æ€æ˜¾ç¤ºæ›´æ–°ä¸º"å·²ç™»å½•"
- å¯ä»¥æ­£å¸¸ä½¿ç”¨æŠ–éŸ³è§†é¢‘è½¬å½•åŠŸèƒ½

## çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | æè¿° |
|-----|------|
| æœªç™»å½• | å½“å‰æ²¡æœ‰æœ‰æ•ˆçš„cookies |
| æ­£åœ¨åˆå§‹åŒ–æµè§ˆå™¨... | æ­£åœ¨å¯åŠ¨è‡ªåŠ¨åŒ–æµè§ˆå™¨ |
| äºŒç»´ç å·²ç”Ÿæˆ | äºŒç»´ç å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…æ‰«æ |
| è¯·ä½¿ç”¨æŠ–éŸ³APPæ‰«æäºŒç»´ç  | æ˜¾ç¤ºäºŒç»´ç ï¼Œç­‰å¾…ç”¨æˆ·æ‰«æ |
| æ‰«ææˆåŠŸï¼Œè¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤ç™»å½• | äºŒç»´ç å·²æ‰«æï¼Œç­‰å¾…æ‰‹æœºç¡®è®¤ |
| ç™»å½•æˆåŠŸï¼Cookieså·²ä¿å­˜ | ç™»å½•å®Œæˆï¼Œcookieså·²æ›´æ–° |
| å·²ç™»å½• | å½“å‰æœ‰æœ‰æ•ˆçš„cookies |

## åŠŸèƒ½æŒ‰é’®

### å¼€å§‹æ‰«ç ç™»å½•
å¯åŠ¨æ‰«ç ç™»å½•æµç¨‹ï¼Œä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨å¹¶ç”ŸæˆäºŒç»´ç ã€‚

### åœæ­¢ç™»å½•
ä¸­æ­¢å½“å‰çš„ç™»å½•æµç¨‹ï¼Œå…³é—­æµè§ˆå™¨å¹¶æ¸…ç†èµ„æºã€‚

### æ£€æŸ¥çŠ¶æ€
æ£€æŸ¥å½“å‰cookiesçš„æœ‰æ•ˆæ€§çŠ¶æ€ï¼Œæ›´æ–°æ˜¾ç¤ºçŠ¶æ€ã€‚

## APIæ¥å£

### WebSocketæ¥å£

è¿æ¥åœ°å€ï¼š`ws://localhost:8000/ws/auth/douyin`

#### æ¶ˆæ¯æ ¼å¼

**çŠ¶æ€å˜åŒ–é€šçŸ¥ï¼š**
```json
{
  "type": "status_change",
  "status": "qr_generated",
  "message": "äºŒç»´ç å·²ç”Ÿæˆ"
}
```

**ç™»å½•ç»“æœï¼š**
```json
{
  "type": "login_result",
  "status": "success",
  "message": "ç™»å½•æˆåŠŸ",
  "qr_code": "data:image/png;base64,iVBORw0KGgo...",
  "cookies_count": 6
}
```

**å®¢æˆ·ç«¯æ§åˆ¶ï¼š**
```json
{
  "action": "refresh_qr"  // åˆ·æ–°äºŒç»´ç 
}
```

```json
{
  "action": "stop"  // åœæ­¢ç™»å½•
}
```

### HTTPæ¥å£

#### å¯åŠ¨ç™»å½•
```http
POST /api/v1/auth/douyin/start
```

#### æŸ¥è¯¢çŠ¶æ€
```http
GET /api/v1/auth/douyin/status
```

#### åœæ­¢ç™»å½•
```http
POST /api/v1/auth/douyin/stop
```

## Cookieç®¡ç†

### æ–‡ä»¶ä½ç½®
Cookiesä¿å­˜åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `cookies.txt` æ–‡ä»¶ä¸­ã€‚

### æ ¼å¼è¯´æ˜
ä½¿ç”¨æ ‡å‡†çš„Netscape cookiesæ ¼å¼ï¼š
```
# Netscape HTTP Cookie File
.douyin.com	TRUE	/	FALSE	0	sessionid	xxxxxx
.douyin.com	TRUE	/	FALSE	0	s_v_web_id	xxxxxx
```

### è‡ªåŠ¨å¤‡ä»½
ç³»ç»Ÿä¼šè‡ªåŠ¨å¤‡ä»½cookiesæ–‡ä»¶åˆ° `logs/cookies_backup/` ç›®å½•ï¼Œä¾¿äºæ¢å¤ã€‚

### CookieéªŒè¯
ç³»ç»Ÿä¼šæ£€æŸ¥ä»¥ä¸‹å…³é”®cookiesæ˜¯å¦å­˜åœ¨ï¼š
- `sessionid` / `sessionid_ss`
- `s_v_web_id`
- `ttwid`
- `odin_tt`
- `passport_csrf_token`

## å¸¸è§é—®é¢˜

### Q: äºŒç»´ç æ— æ³•æ˜¾ç¤ºæˆ–ä¸€ç›´åŠ è½½ï¼Ÿ
A: è¯·æ£€æŸ¥ï¼š
- ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
- æ˜¯å¦å®‰è£…äº†Playwrightæµè§ˆå™¨ï¼š`playwright install`
- é˜²ç«å¢™æ˜¯å¦é˜»æ­¢äº†æµè§ˆå™¨å¯åŠ¨

### Q: æ‰«ç åæ˜¾ç¤º"ç™»å½•å¤±è´¥"ï¼Ÿ
A: å¯èƒ½çš„åŸå› ï¼š
- äºŒç»´ç å·²è¿‡æœŸï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
- ç½‘ç»œè¿æ¥ä¸­æ–­
- æŠ–éŸ³å®‰å…¨ç­–ç•¥å˜åŒ–

è§£å†³æ–¹æ³•ï¼šç‚¹å‡»"åœæ­¢ç™»å½•"åé‡æ–°å¼€å§‹ã€‚

### Q: ç™»å½•æˆåŠŸä½†è§†é¢‘è§£æä»ç„¶å¤±è´¥ï¼Ÿ
A: è¯·æ£€æŸ¥ï¼š
- Cookiesæ–‡ä»¶æ˜¯å¦æ­£ç¡®ç”Ÿæˆï¼ˆ`cookies.txt`ï¼‰
- å°è¯•é‡å¯APIæœåŠ¡ä½¿æ–°cookiesç”Ÿæ•ˆ
- æ£€æŸ¥cookiesæ˜¯å¦åŒ…å«å¿…è¦çš„å­—æ®µ

### Q: å¦‚ä½•çŸ¥é“cookiesæ˜¯å¦è¿‡æœŸï¼Ÿ
A: å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ£€æŸ¥ï¼š
- ç‚¹å‡»"æ£€æŸ¥çŠ¶æ€"æŒ‰é’®
- è§‚å¯Ÿè§†é¢‘è§£ææ˜¯å¦æˆåŠŸ
- æŸ¥çœ‹APIè¿”å›çš„é”™è¯¯ä¿¡æ¯

### Q: å¯ä»¥åŒæ—¶ç™»å½•å¤šä¸ªæŠ–éŸ³è´¦å·å—ï¼Ÿ
A: å½“å‰ç‰ˆæœ¬æ¯æ¬¡åªèƒ½ä¿å­˜ä¸€ä¸ªè´¦å·çš„cookiesã€‚å¦‚éœ€åˆ‡æ¢è´¦å·ï¼Œè¯·é‡æ–°è¿›è¡Œæ‰«ç ç™»å½•ã€‚

## æŠ€æœ¯åŸç†

### æµè§ˆå™¨è‡ªåŠ¨åŒ–
ä½¿ç”¨Playwrightæ¡†æ¶æ§åˆ¶Chromiumæµè§ˆå™¨ï¼š
- è®¿é—®æŠ–éŸ³å®˜æ–¹ç™»å½•é¡µé¢
- è‡ªåŠ¨ç‚¹å‡»æ‰«ç ç™»å½•é€‰é¡¹
- æˆªå–äºŒç»´ç å›¾ç‰‡
- ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–

### å®æ—¶é€šä¿¡
é€šè¿‡WebSocketæä¾›å®æ—¶çŠ¶æ€æ›´æ–°ï¼š
- äºŒç»´ç ç”Ÿæˆé€šçŸ¥
- ç™»å½•è¿›åº¦çŠ¶æ€
- é”™è¯¯ä¿¡æ¯åé¦ˆ

### å®‰å…¨ä¿æŠ¤
- ä½¿ç”¨å®˜æ–¹ç™»å½•æµç¨‹ï¼Œä¸æ¶‰åŠè´¦å·å¯†ç 
- æœ¬åœ°å­˜å‚¨cookiesï¼Œä¸ä¸Šä¼ åˆ°å¤–éƒ¨æœåŠ¡å™¨
- è‡ªåŠ¨æ¸…ç†æµè§ˆå™¨æ•°æ®

### Cookieæå–
- è¿‡æ»¤æŠ–éŸ³ç›¸å…³åŸŸåçš„cookies
- æå–å…³é”®è®¤è¯å­—æ®µ
- è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼ä¿å­˜

## ä¾èµ–è¦æ±‚

### PythonåŒ…
```
playwright>=1.40.0
Pillow>=10.1.0
```

### ç³»ç»Ÿè¦æ±‚
- æ”¯æŒå›¾å½¢ç•Œé¢çš„æ“ä½œç³»ç»Ÿ
- è¶³å¤Ÿçš„å†…å­˜è¿è¡Œæµè§ˆå™¨ï¼ˆå»ºè®®4GBä»¥ä¸Šï¼‰
- ç¨³å®šçš„ç½‘ç»œè¿æ¥

### å®‰è£…è¯´æ˜
```bash
# å®‰è£…Pythonä¾èµ–
pip install playwright Pillow

# å®‰è£…æµè§ˆå™¨
playwright install

# æˆ–è€…åªå®‰è£…Chromium
playwright install chromium
```

## é«˜çº§é…ç½®

### æµè§ˆå™¨é€‰é¡¹
å¯ä»¥åœ¨ `core/douyin_auth.py` ä¸­è°ƒæ•´æµè§ˆå™¨å¯åŠ¨å‚æ•°ï¼š

```python
self.browser = await self.playwright.chromium.launch(
    headless=True,  # è®¾ç½®ä¸ºFalseå¯ä»¥çœ‹åˆ°æµè§ˆå™¨ç•Œé¢
    args=[
        '--no-sandbox',
        '--disable-blink-features=AutomationControlled',
        '--disable-dev-shm-usage',
    ]
)
```

### è¶…æ—¶è®¾ç½®
```python
self.timeout = 300  # ç™»å½•è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
self.check_interval = 2  # çŠ¶æ€æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
```

### è‡ªå®šä¹‰User-Agent
```python
user_agent = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
```

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-01-XX)
- âœ¨ æ–°å¢æŠ–éŸ³æ‰«ç ç™»å½•åŠŸèƒ½
- ğŸ”„ æ”¯æŒå®æ—¶çŠ¶æ€æ›´æ–°
- ğŸ›¡ï¸ å¢å¼ºé”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- ğŸ“± ä¼˜åŒ–ç§»åŠ¨ç«¯æ‰«ç ä½“éªŒ
- ğŸ’¾ è‡ªåŠ¨cookieç®¡ç†å’Œå¤‡ä»½

## åé¦ˆä¸æ”¯æŒ

å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥ `logs/api.log` æ–‡ä»¶
3. åœ¨é¡¹ç›®GitHubé¡µé¢æäº¤Issue
4. æä¾›è¯¦ç»†çš„é”™è¯¯æè¿°å’Œæ—¥å¿—ä¿¡æ¯

---

**æ³¨æ„ï¼š** æ­¤åŠŸèƒ½éœ€è¦åˆè§„ä½¿ç”¨ï¼Œè¯·éµå®ˆæŠ–éŸ³å¹³å°çš„ä½¿ç”¨æ¡æ¬¾å’Œç›¸å…³æ³•å¾‹æ³•è§„ã€‚